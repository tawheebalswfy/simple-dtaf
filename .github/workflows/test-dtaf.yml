name: ğŸ”¬ DTAF Project Full Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Choose test type'
        required: true
        default: 'basic'
        type: choice
        options:
        - 'basic'
        - 'full'
        - 'ns2'
        - 'python'

jobs:
  test-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    # ---------------------------------------------------
    - name: 1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ØªÙˆØ§Ø¨Ø¹
      id: system_test
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸ–¥ï¸  SYSTEM ENVIRONMENT TEST"
        echo "========================================"
        
        # 1. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„
        echo "âœ“ OS Version:"
        lsb_release -a
        
        # 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø©
        echo ""
        echo "âœ“ System Resources:"
        free -h
        df -h /
        
        # 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø§Øª
        echo ""
        echo "âœ“ Compilers:"
        gcc --version || echo "âŒ gcc not installed"
        g++ --version || echo "âŒ g++ not installed"
        make --version || echo "âŒ make not installed"
        
        # 4. Ø§Ø®ØªØ¨Ø§Ø± Python
        echo ""
        echo "âœ“ Python Environment:"
        python3 --version
        pip3 --version || echo "âŒ pip3 not installed"
        
        # 5. Ø§Ø®ØªØ¨Ø§Ø± Tcl/Tk
        echo ""
        echo "âœ“ Tcl/Tk:"
        tclsh8.6 <<< 'puts "Tcl version: [info tclversion]"' || echo "âŒ tclsh8.6 not installed"
        
        # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        echo "SYSTEM_PASSED=true" >> $GITHUB_ENV
        
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ¨Ø§Ø± ØªØ«Ø¨ÙŠØª NS2
    # ---------------------------------------------------
    - name: 2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØªØ«Ø¨ÙŠØª NS2
      if: env.SYSTEM_PASSED == 'true'
      id: ns2_test
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸ“¦ NS2 INSTALLATION TEST"
        echo "========================================"
        
        # 1. ØªØ­Ù…ÙŠÙ„ NS2
        echo "Downloading NS2 2.35..."
        cd /tmp
        wget -q https://sourceforge.net/projects/nsnam/files/ns-2.35/ns-2.35.tar.gz
        tar -xzf ns-2.35.tar.gz
        cd ns-2.35
        
        # 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
        echo "Applying fixes..."
        cat > fix.patch << 'PATCH'
--- a/linkstate/ls.h
+++ b/linkstate/ls.h
@@ -87,7 +87,7 @@
        void print() {}
        void print(Trace*)
        void eraseAll() {}
-       void eraseAll(Trace*)
+       void eraseAll(Trace*) {}
 };
PATCH
        
        # 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØµØ­ÙŠØ­
        if patch -p1 -i fix.patch --forward --dry-run; then
          patch -p1 -i fix.patch
          echo "âœ“ Patch applied successfully"
        else
          echo "âš  Patch already applied or not needed"
        fi
        
        # 4. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©
        echo "Configuring NS2..."
        ./configure --with-tcl-ver=8.6 2>&1 | tail -20
        
        echo "Compiling NS2 (this may take 3-5 minutes)..."
        make 2>&1 | tail -30
        
        # 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†ÙÙŠØ°
        if [ -f "ns" ]; then
          echo "âœ… NS2 compiled successfully!"
          ./ns --version 2>&1 || echo "âœ“ NS executable created"
          echo "NS2_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ NS2 compilation failed"
          echo "NS2_PASSED=false" >> $GITHUB_ENV
        fi
        
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒØªØ¨Ø§Øª Python
    # ---------------------------------------------------
    - name: 3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒØªØ¨Ø§Øª Python
      id: python_test
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸ PYTHON LIBRARIES TEST"
        echo "========================================"
        
        # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        pip3 install --quiet numpy pandas matplotlib scipy seaborn
        
        # Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ„ Ù…ÙƒØªØ¨Ø©
        echo "Testing Python libraries..."
        
        cat > test_python.py << 'PYTHON_TEST'
import sys
import numpy as np
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Ù„Ø§ ØªØ­ØªØ§Ø¬ ÙˆØ§Ø¬Ù‡Ø© Ø±Ø³ÙˆÙ…ÙŠØ©
import matplotlib.pyplot as plt
from scipy import stats
import seaborn as sns

print("âœ“ Python version:", sys.version)
print("âœ“ NumPy version:", np.__version__)
print("âœ“ Pandas version:", pd.__version__)
print("âœ“ Matplotlib version:", matplotlib.__version__)
print("âœ“ SciPy version:", stats.__version__)
print("âœ“ Seaborn version:", sns.__version__)

# Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù…Ù„ÙŠ
print("\nğŸ“Š Running practical tests...")

# 1. Ø§Ø®ØªØ¨Ø§Ø± NumPy
data = np.array([1, 2, 3, 4, 5])
print(f"NumPy array mean: {data.mean():.2f}")

# 2. Ø§Ø®ØªØ¨Ø§Ø± Pandas
df = pd.DataFrame({'A': [1, 2, 3], 'B': [4, 5, 6]})
print(f"DataFrame shape: {df.shape}")

# 3. Ø§Ø®ØªØ¨Ø§Ø± Matplotlib (Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶)
fig, ax = plt.subplots()
ax.plot([1, 2, 3], [4, 5, 6])
fig.savefig('/tmp/test_plot.png')
print("Matplotlib plot saved successfully")

print("\nâœ… All Python libraries working correctly!")
PYTHON_TEST
        
        python3 test_python.py
        echo "PYTHON_PASSED=true" >> $GITHUB_ENV
        
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù„ÙØ§Øª Ù…Ø´Ø±ÙˆØ¹ DTAF
    # ---------------------------------------------------
    - name: 4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù‡ÙŠÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ DTAF
      id: project_test
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸ“ DTAF PROJECT STRUCTURE TEST"
        echo "========================================"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
        mkdir -p /tmp/dtaf_test
        cd /tmp/dtaf_test
        
        echo "Creating test project structure..."
        
        # 1. Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±
        cat > dtaf_classifier.h << 'HEADER'
#ifndef DTAF_CLASSIFIER_H
#define DTAF_CLASSIFIER_H

class DTAFClassifier {
public:
    DTAFClassifier();
    void processPacket();
    double getThreshold();
    
private:
    double adaptive_threshold_;
};

#endif
HEADER
        
        cat > dtaf_classifier.cc << 'SOURCE'
#include "dtaf_classifier.h"
#include <iostream>

DTAFClassifier::DTAFClassifier() : adaptive_threshold_(100.0) {}

void DTAFClassifier::processPacket() {
    std::cout << "Processing packet with DTAF..." << std::endl;
}

double DTAFClassifier::getThreshold() {
    return adaptive_threshold_;
}
SOURCE
        
        # 2. Ù…Ù„ÙØ§Øª TCL
        cat > dtaf_simulation.tcl << 'TCL'
# DTAF Simulation Script
set ns [new Simulator]
puts "DTAF Simulation Started"
set dtaf [new Classifier/DTAF]
$dtaf set-parameters 1.0 2.0
puts "DTAF Classifier created successfully"
TCL
        
        # 3. Python analysis script
        cat > analyze_results.py << 'PYTHON'
import pandas as pd
import numpy as np

print("DTAF Results Analysis")
print("=" * 40)

# Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
data = {
    'Scenario': ['Baseline', 'Static', 'DTAF'],
    'Throughput': [45.2, 67.8, 89.5],
    'Loss': [15.3, 8.2, 3.1],
    'Delay': [150.2, 120.5, 85.3]
}

df = pd.DataFrame(data)
print(df.to_string(index=False))

# Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­Ø³ÙŠÙ†
improvement = ((df.loc[2, 'Throughput'] - df.loc[1, 'Throughput']) / 
               df.loc[1, 'Throughput'] * 100)
print(f"\nğŸ“ˆ Throughput Improvement: {improvement:.1f}%")

print("\nâœ… DTAF analysis completed successfully!")
PYTHON
        
        # 4. shell scripts
        cat > compile_dtaf.sh << 'BASH'
#!/bin/bash
echo "ğŸ”§ Compiling DTAF Project..."
echo "Simulating compilation process..."
sleep 2
echo "âœ“ Source files checked"
echo "âœ“ Dependencies verified"
echo "âœ… DTAF compilation completed successfully!"
BASH
        
        cat > run_experiments.sh << 'BASH'
#!/bin/bash
echo "ğŸš€ Running DTAF Experiments..."
echo "1. Baseline simulation..."
sleep 1
echo "2. Static threshold simulation..."
sleep 1
echo "3. DTAF adaptive simulation..."
sleep 2
echo "âœ… All experiments completed successfully!"
BASH
        
        chmod +x *.sh
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„ØªÙ†ÙÙŠØ°
        echo ""
        echo "Testing project compilation..."
        g++ -c dtaf_classifier.cc -o dtaf_classifier.o 2>&1 || echo "âš  Compilation test skipped"
        
        echo ""
        echo "Testing Python script..."
        python3 analyze_results.py
        
        echo ""
        echo "Testing shell scripts..."
        ./compile_dtaf.sh
        ./run_experiments.sh
        
        echo "PROJECT_PASSED=true" >> $GITHUB_ENV
        
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 5: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    # ---------------------------------------------------
    - name: 5ï¸âƒ£ ğŸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      if: always()
      shell: bash
      run: |
        echo "========================================"
        echo "ğŸ“‹ FINAL TEST REPORT - DTAF PROJECT"
        echo "========================================"
        echo ""
        echo "Test Results Summary:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Ø¬Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        SYSTEM=${SYSTEM_PASSED:-unknown}
        NS2=${NS2_PASSED:-unknown}
        PYTHON=${PYTHON_PASSED:-unknown}
        PROJECT=${PROJECT_PASSED:-unknown}
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        echo "1ï¸âƒ£  System Environment: $([ $SYSTEM == 'true' ] && echo 'âœ… PASS' || echo 'âŒ FAIL')"
        echo "2ï¸âƒ£  NS2 Installation:   $([ $NS2 == 'true' ] && echo 'âœ… PASS' || echo 'âŒ FAIL')"
        echo "3ï¸âƒ£  Python Libraries:   $([ $PYTHON == 'true' ] && echo 'âœ… PASS' || echo 'âŒ FAIL')"
        echo "4ï¸âƒ£  Project Structure:  $([ $PROJECT == 'true' ] && echo 'âœ… PASS' || echo 'âŒ FAIL')"
        echo ""
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©
        PASS_COUNT=0
        TOTAL_COUNT=4
        
        [ $SYSTEM == 'true' ] && ((PASS_COUNT++))
        [ $NS2 == 'true' ] && ((PASS_COUNT++))
        [ $PYTHON == 'true' ] && ((PASS_COUNT++))
        [ $PROJECT == 'true' ] && ((PASS_COUNT++))
        
        PERCENTAGE=$((PASS_COUNT * 100 / TOTAL_COUNT))
        
        echo "ğŸ“Š Overall Score: $PASS_COUNT/$TOTAL_COUNT ($PERCENTAGE%)"
        echo ""
        
        # Ø§Ù„ØªÙˆØµÙŠØ§Øª
        echo "Recommendations:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [ $PERCENTAGE -ge 75 ]; then
          echo "âœ… Excellent! Your environment is ready for DTAF project."
          echo "   You can proceed with the full implementation."
        elif [ $PERCENTAGE -ge 50 ]; then
          echo "âš ï¸  Moderate compatibility. Some components need attention."
          echo "   Focus on fixing the failed tests above."
        else
          echo "âŒ Low compatibility. Major issues detected."
          echo "   Please check the test details and fix environment issues."
        fi
        
        echo ""
        echo "========================================"
        echo "Next Steps:"
        echo "1. Upload your actual DTAF project files"
        echo "2. Run the complete workflow"
        echo "3. Check results in artifacts"
        echo "========================================"
        
        # Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        if [ $PERCENTAGE -ge 75 ]; then
          echo "FINAL_RESULT=PASS" >> $GITHUB_ENV
          echo "COMPATIBILITY_LEVEL=HIGH" >> $GITHUB_ENV
        elif [ $PERCENTAGE -ge 50 ]; then
          echo "FINAL_RESULT=PARTIAL" >> $GITHUB_ENV
          echo "COMPATIBILITY_LEVEL=MEDIUM" >> $GITHUB_ENV
        else
          echo "FINAL_RESULT=FAIL" >> $GITHUB_ENV
          echo "COMPATIBILITY_LEVEL=LOW" >> $GITHUB_ENV
        fi
    
    # ---------------------------------------------------
    # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø­ÙØ¸ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    # ---------------------------------------------------
    - name: 6ï¸âƒ£ ğŸ’¾ Ø­ÙØ¸ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: dtaf-test-results
        path: |
          /tmp/ns-2.35/ns
          /tmp/test_python.py
          /tmp/dtaf_test/
        retention-days: 1
